<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Pet Connect Lines</title>
  <meta name="description" content="Pet connect lines">
  <meta name="author" content="Lingyi Hu">
  <style>
    html, body {
      font-family: Garamond, serif;
      background: #f9f9f9;
      color: #4a4a4a;
    }
    button {
      background: #f2f2f2;
      color: #191919;
      cursor: pointer;
      display: inline;
      margin-bottom: 18px;
      margin-right: 7.2px;
      padding: 6.525px 23.4px;
      text-align: center;
      border: 0;
      border-radius: 3.6px;
    }
    button:hover {
      background: #d9d9d9;
      color: #000;
    }
    #main {
      width: 560px; /*16 * 40*/
      margin: 0 auto;
      margin-top: 2rem;
      /*border: solid 1px;*/
    }
    .tile {
      vertical-align: top;
      height: 40px;
      width: 40px;
    }
    .tile:hover:not(.transparent) {
      cursor: pointer;
    }
    .tile.selected {
      background-color: red;
    }
    .path-highlight {
      background-color: lightgray;
    }
    .centered {
      position: fixed;
      top: 50%;
      left: 50%;
      /* bring your own prefixes */
      transform: translate(-50%, -50%);
    }
    .message {
      text-align: center;
      display: none;
    }
    #progress-bar {
      width: 100%;
      height: 20px;
      background-color: red;
    }
    .hint {
      background-color: black;
    }
  </style>
</head>

<body>
  
  <div id="progress-bar"></div>
  <div id="main"></div>
  
  <div class="centered message" id="ultimate-success-message">
    <h1>Congratulations! You have completed the game!</h1>
    <button onclick="location.reload()">Restart</button>
  </div>
  <div class="centered message" id="success-message">
    <h1>Success!</h1>
    <button onclick="next_level()">Next Level</button>
  </div>
  <div class="centered message" id="failure-message">
    <h1>Uh oh, you ran out of time!</h1>
    <button onclick="location.reload()">Try again</button>
  </div>
  <div style="text-align: center;">
    <h2 id="level-indicator"></h2>
  </div>
  <div style="text-align: center;"><button onclick="show_hint()">Show Hint</button><button onclick="reshuffle_game()">Reshuffle</button><button onclick="pause_game()">Pause</button><button onclick="unpause_game()">Resume</button></div>

  <script src="main.js"></script>
  <script>
    const folder = "animals/";
    const timer_upper_limit = 3*60 + 20;
    const success_added_time = 4; // seconds

    let current_lvl = 1;
    let tmp = generate_game(DIM, current_lvl);
    let game = tmp[0];
    let vmove = tmp[1];
    let allowed_time = timer_upper_limit; // seconds
    let timer = setInterval(update_timer, 1000);
    let game_active = true;
    update_level();
    render_game(game);

    function update_timer() {
      allowed_time -= 1;
      update_progress_bar()
      if (allowed_time === 0) {
        document.getElementById("failure-message").style.display = "block";
        document.getElementById("main").style.opacity = 0.2;
        game_active = false;
        clearInterval(timer); return;
      }
    }

    function next_level() {
      if (current_lvl === MAX_LEVEL) {
        return;
      }
      document.getElementById("success-message").style.display = "none";
      document.getElementById("failure-message").style.display = "none";
      current_lvl += 1;
      update_level();
      // reset
      clearInterval(timer);
      allowed_time = timer_upper_limit;
      timer = setInterval(update_timer, 1000);
      tmp = generate_game(DIM, current_lvl);
      game = tmp[0];
      vmove = tmp[1];
      game_active = true;
      render_game(game);
    }

    function update_level() {
      document.getElementById("level-indicator").innerHTML = `Level ${current_lvl}/${MAX_LEVEL}: ${LEVEL_NAMES[current_lvl]}`;
    }

    function update_progress_bar() {
      if (game_active === false) {
        return;
      }
      let percentage = allowed_time / timer_upper_limit * 100
      document.getElementById("progress-bar").style.width = `${percentage}%`;
    }

    function render_game(game) {
      let maindiv = document.getElementById("main");
      maindiv.opacity = 1;
      while (maindiv.firstChild) { // clear maindiv first before generating
          maindiv.removeChild(maindiv.firstChild);
      }
      for (i = 0; i < DIM[0] + 2; i++) {
        for (i2 = 0; i2 < DIM[1] + 2; i2++) {
          if (i === 0 | i2 === 0 | i === DIM[0] + 1| i2 === DIM[1] + 1) {
            continue;
          }
          var elem = document.createElement("img");
          if (game[i][i2] === -1) {
            elem.setAttribute("class", "tile");
            elem.setAttribute("id", `tile-${i}-${i2}`);
            elem.setAttribute("tile_row", i);
            elem.setAttribute("tile_col", i2);
            elem.classList.add("transparent")
            elem.src = folder + "transparent.svg";
          } else {
            elem.setAttribute("class", "tile");
            elem.setAttribute("id", `tile-${i}-${i2}`);
            elem.setAttribute("tile_row", i);
            elem.setAttribute("tile_col", i2);
            elem.setAttribute("onclick", "select_tile(this)")
            elem.src = folder + "item (" + (game[i][i2]+1) + ").svg";
          }
          maindiv.appendChild(elem);
        }
        // var linebreak = document.createElement("br")
        // maindiv.appendChild(br)
      }
    }

    function replace_with_transparent(elem) {
        elem.classList.add("transparent");
        elem.src = folder + "transparent.svg";
    }

    function render_changed_tiles(changed_tiles) {
      for (var ct = 0; ct < changed_tiles.length; ct++) {
        idx = changed_tiles[ct];
        if (game[idx[0]][idx[1]] === -1) {
          replace_with_transparent(document.getElementById(`tile-${idx[0]}-${idx[1]}`));
        } else {
          let elem = document.getElementById(`tile-${idx[0]}-${idx[1]}`);
          elem.classList.remove("transparent");
          elem.setAttribute("onclick", "select_tile(this)")
          elem.src = folder + "item (" + (game[idx[0]][idx[1]]+1) + ").svg";
        }
      }
    }

    function select_tile(elem) {
      if (game_active === false) {
        return;
      }
      let i = parseInt(elem.getAttribute("tile_row"));
      let i2 = parseInt(elem.getAttribute("tile_col"));
      if (game[i][i2] === -1) { return; }
      if (selected == -1) {
        elem.classList.add("selected");
        selected = [i, i2];
        return;
      }
      if (selected[0] == i && selected[1] == i2) { // they are the same tile
        elem.classList.remove("selected");
        selected = -1;
        return;
      }
      if (game[selected[0]][selected[1]] === game[i][i2]) {  // if same animal
        // see if there is shortest path
        let result = shortest_path(game, selected, [i, i2]);
        if (result == -1) { // no valid path, deselect both
          elem.classList.remove("selected");
          deselect_tile(selected[0], selected[1]);
          selected = -1;
          return;
        } else {
          destroy_animal(game, selected);
          destroy_animal(game, [i, i2]);

          replace_with_transparent(document.getElementById(`tile-${selected[0]}-${selected[1]}`));
          replace_with_transparent(document.getElementById(`tile-${i}-${i2}`));

          deselect_tile(selected[0], selected[1]);
          selected = -1;

          let changed_tiles = LEVEL_FNS[current_lvl](game);
          render_changed_tiles(changed_tiles);

          if (allowed_time <= timer_upper_limit - success_added_time) {
            allowed_time += success_added_time;
          } else {
            allowed_time = timer_upper_limit;
          }
          update_progress_bar();
          if (is_empty(game) === true) {
            if (current_lvl === MAX_LEVEL) {
              document.getElementById("ultimate-success-message").style.display = "block";
            } else {
              document.getElementById("success-message").style.display = "block";
            }
            clearInterval(timer);
            game_active = false;
            return;
          }

          // check valid move
          vmove = find_valid_move(game)
          if (vmove === null) {
            console.log("no valid moves");
            reshuffle_game();
          }
        }
      } else {
        elem.classList.add("selected");
        deselect_tile(selected[0], selected[1]);
        selected = [i, i2];
      }
    }

    function deselect_tile(row, col) {
      if (game_active === false) {
        return;
      }
      document.getElementById(`tile-${row}-${col}`).classList.remove("selected");
    }

    function show_hint() {
      if (game_active === false) {
        return;
      }
      let start = vmove[0].pos
      let end = vmove[vmove.length - 1].pos

      let elements = [document.getElementById(`tile-${start[0]}-${start[1]}`), document.getElementById(`tile-${end[0]}-${end[1]}`)];
      for (var i = 0; i < elements.length; i++) {
        elements[i].classList.add("hint");
      }

      setTimeout(function () {
        for (var i = 0; i <  elements.length; i++) {
          elements[i].classList.remove("hint")
        }
      }, 1000)
    }

    function reshuffle_game() {
      if (game_active === false) {
        return;
      }
      reshuffle(game);
      vmove = find_valid_move(game);
      if (vmove === null) {
        reshuffle_game()
      }
      render_game(game);
    }

    function pause_game() {
      clearInterval(timer);
      game_active = false;
      document.getElementById("main").style.opacity = 0.2;
    }

    function unpause_game() {
      clearInterval(timer);
      timer = setInterval(update_timer, 1000);
      game_active = true;
      document.getElementById("main").style.opacity = 1;
    }

  </script>
</body>
</html>